### **项目文档：ETF 投资策略设计与回测工具 (V2.1)**

#### **1. 项目愿景与核心理念**

本工具旨在为投资者提供一个强大而直观的量化平台，将模糊的投资想法转化为精确、可回测的策略。核心理念是**从传统的“定时定额”投资模式，升级为灵活的“信号驱动”投资模式**。投资行为不再由固定的日历驱动，而是由用户定义的、可量化的市场“机会信号”来触发，从而实现真正的“低买高卖”投资哲学。

---

### **2. 核心功能模块**

#### **模块一：数据引擎 (Data Engine)**

**目标**: 为回测引擎提供准确、干净、标准化的 ETF 历史数据。

- **输入**:

  - ETF 代码 (例如: QQQ, SPY)
  - 回测时间范围 (例如: 2015-01-01 至 2024-12-31)

- **核心功能**:
  1.  **数据获取**: 通过可靠的公开数据源 (如 Yahoo Finance API) 下载指定 ETF 的日级别历史行情数据，包括开盘价(Open)、最高价(High)、最低价(Low)、收盘价(Close)和成交量(Volume)。
  2.  **数据处理**: 自动处理数据清洗，如填补缺失值、处理节假日等。
  3.  **周期聚合**: 根据日线数据，在内部动态计算生成周、月、季度的行情数据，以支持不同时间维度的策略条件判断。
  4.  **指标计算**: 预先计算策略设计器中所需的所有技术指标（如 MA, RSI, MACD, 布林带），供回测时高速调用。

---

#### **模块二：策略设计器 (Strategy Designer)**

**目标**: 提供一个高度可视化、以“信号驱动”为核心的无代码策略构建界面。用户通过组合“触发器”来完整定义自己的投资体系。

- **核心组件**:

  1.  **初始状态设置**:

      - **初始本金**: 用户设定回测开始时的起始资金。

  2.  **触发器构建系统 (Trigger-Based System)**: 策略由一个或多个“触发器”组成，每个触发器都是一条独立的 `IF [条件] THEN [动作]` 指令。

  3.  **触发器构建器 (The Trigger Builder)**: 用于创建和编辑单个触发器的界面。

      - **A. IF - 定义“机会信号” (The Condition)**:

        - 采用**分层分组的下拉菜单**，引导用户优先使用价格行为。

        - **--- 核心：基于价格行为的信号 ---** (默认首选)

          - `价格连续涨跌`: 捕捉短期动量。 (例: 连续下跌 3 天)
          - `价格创下新高/新低`: 基于关键价位的突破。 (例: 创下 52 周新低)
          - `价格从高点回撤`: **核心功能**，量化“打折”程度。 (例: 从 60 日高点下跌超过 15%)
          - `价格在周期内涨跌幅`: 衡量市场波动性。 (例: 20 日内下跌超过 10%)

        - **--- 辅助：基于技术指标的信号 ---** (高级选项，可折叠)

          - `RSI 指标`: 判断超买超卖。 (例: 14 日 RSI 低于 30)
          - `移动平均线 (MA)`: 判断长期趋势。 (例: 价格跌破 200 日均线)
          - `布林带 (Bollinger Bands)`: 判断价格相对高低。 (例: 价格触及布林带下轨)
          - `MACD`: 判断趋势动能转换。 (例: MACD 金叉)

        - **--- 其他：基于时间的信号 ---** (用于策略对比)
          - `固定时间周期`: 实现传统定投。 (例: 每个月的第一个交易日)

      - **B. THEN - 定义“执行动作” (The Action)**:

        - **动作类型**: `买入` 或 `卖出`。
        - **动作数值**:
          - `固定金额`: (例: 买入 1000 元)
          - `可用现金的百分比`: (例: 买入 20% 的可用现金)
          - `账户总值的百分比`: (例: 买入 1% 的账户总值)
          - `持仓的百分比`: (例: 卖出 10% 的现有持仓)

      - **C. 频率控制 (Frequency Control)**:
        - **冷却期 (Cooldown)**: 设置一个触发器在执行后的一段时间内（例如 5 个交易日）不再重复触发，以避免在同一信号下过度交易。

  4.  **触发器管理列表**:
      - **策略容器概念**: 明确所有触发器属于同一个策略。
      - 以清晰的自然语言列表形式展示所有已添加的触发器 (例如：“规则 1：如果价格从 60 日高点下跌超过 15%，那么买入 1000 元”)。
      - 提供对每条规则的 `编辑` 和 `删除` 功能。

---

#### **模块三：结果可视化引擎 (Visualization Engine)**

**目标**: 提供机构级的交互式图表体验。

- **技术实现**: 使用 `Chart.js` 或 `ECharts`。
- **核心特性**:
  1.  **多维对比**: 支持策略净值、基准净值、标的价格的三维对比（双 Y 轴）。
  2.  **信号标注**: 自动将后端返回的 `trades` 数组映射到时间轴上，生成买卖标记。
  3.  **动态交互**: 用户可以点击图例(Legend)来隐藏/显示特定的曲线，聚焦于他关心的部分。

#### **模块四：用户资产管理 (User Asset Management)**

**目标**: 利用 Cloudflare 的免费资源实现完整的用户数据持久化。

- **存储方案**:
  - **Cloudflare D1 (SQLite)**: 存储用户的策略配置 JSON。由于策略配置通常只有几 KB，D1 的免费额度（每天 500 万行读取）对于个人或小型 SaaS 绰绰有余。
  - **数据结构**: `Strategy` 表包含 `id`, `user_id`, `name`, `config_json` (TEXT 类型), `is_public` (公开/私有), `created_at`。
- **安全性**:
  - 所有读写操作均通过 Firebase Auth Token 进行鉴权，确保用户只能访问自己的策略（除非策略被设为公开）。

#### **模块五：社区与发现 (Community & Discovery)**

**目标**: 打破信息孤岛，让优质策略被更多人看见，促进知识共享。

- **策略公开性**:

  - 用户在保存策略时，可以选择将其设为 **"公开" (Public)** 或 **"私有" (Private)**。默认私有。
  - 公开策略将允许其他用户查看配置、运行回测，并基于此创建副本（Fork）。

- **策略排行榜 (Leaderboard)**:

  - **展示逻辑**: 无论用户是否登录，均可访问排行榜页面。
  - **排名维度**: 支持按多种指标排序，如 "近 3 年回报率"、"夏普比率"、"最大回撤"、"被收藏数"。
  - **时间范围**: 默认展示基于最近 3-5 年回测数据的表现。

- **互动与讨论 (Interaction & Discussion)**:
  - **评论系统**: 用户可以对公开的策略发表看法、提问或建议。
  - **回复功能 (Threaded Replies)**: 支持对具体的评论进行回复，形成对话线程（楼中楼模式），方便针对特定问题进行深入探讨。
  - **权限**:
    - **查看**: 所有人（包括未登录用户）均可查看评论区。
    - **发布**: 仅登录用户可以发表评论或回复。
    - **管理**: 用户可以删除自己的评论；策略作者可以删除其策略下的任何评论（防骚扰）。

---

### **3. 回测引擎 (Backtesting Engine)**

**目标**: 精确模拟用户设计的策略在指定的历史时间段内的每一次决策和交易，生成每日的账户资产数据。

- **工作流程**:
  1.  **初始化**: 根据用户设置的“初始本金”创建模拟账户。
  2.  **时间穿梭**: 以“天”为单位，从回测开始日期遍历到结束日期。
  3.  **信号扫描**: 在每一天，引擎会检查“策略设计器”中定义的所有触发器（未处于冷却期的）。
  4.  **条件判断**: 利用历史数据判断每个触发器的“IF 条件”是否被满足。
  5.  **执行交易**: 如果条件满足，则执行对应的“THEN 动作”，模拟买入或卖出，并更新账户中的现金和 ETF 持有份额。交易价格统一按当日收盘价计算。
  6.  **账户更新**: 实时计算并更新账户总资产（市值 + 现金）。
  7.  **分红处理**: 在回测过程中自动处理 ETF 的分红事件，并默认将分红现金再投资。
  8.  **日志记录**: 记录每一笔模拟交易的细节（日期、价格、数量、原因）和每日的账户净值，供最终分析使用。

---

### **4. 性能分析与对比 (Performance Analysis & Comparison)**

**目标**: 将回测结果以直观、多维度的方式呈现给用户，并提供关键的基准对比，以判断策略的有效性。

- **核心功能**:

  1.  **关键性能指标 (KPIs) 展示**:

      - **总回报率 / 年化回报率**
      - **最大回撤** (衡量策略风险的关键指标)
      - **夏普比率** (衡量风险调整后收益)
      - **波动率**

  2.  **策略基准对比 (Benchmark Comparison)**: 这是本工具价值的核心体现。系统会自动将用户的策略与以下基准策略进行对比：

      - **买入并持有 (Buy and Hold)**: 在第一天用全部资金买入并持有到最后。
      - **传统定时定额 (DCA)**: 在固定的时间周期（如每月）投入固定的金额。

  3.  **数据可视化**:
      - **净值曲线图**: 在同一图表中绘制用户策略、买入并持有策略、定投策略的账户净值变化曲线，一目了然地看出超额收益。
      - **年度回报率柱状图**: 对比不同策略在每年的回报表现。
      - **回撤深度图**: 可视化展示策略历史上净值下跌的过程，让用户直观感受风险。

---

#### **模块五：社区与发现 (Community & Discovery)**

**目标**: 打破信息孤岛，让优质策略被更多人看见，促进知识共享。

- **策略公开性**: (保持不变...)
- **策略排行榜**: (保持不变...)

- **互动与讨论 (Interaction & Discussion)**: **[新增]**
  - **评论系统**: 用户可以对公开的策略发表看法、提问或建议。
  - **回复功能 (Threaded Replies)**: 支持对具体的评论进行回复，形成对话线程（楼中楼模式），方便针对特定问题进行深入探讨。
  - **权限**:
    - **查看**: 所有人（包括未登录用户）均可查看评论区。
    - **发布**: 仅登录用户可以发表评论或回复。
    - **管理**: 用户可以删除自己的评论；策略作者可以删除其策略下的任何评论（防骚扰）。
