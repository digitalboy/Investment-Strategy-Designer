

# å†å²æœ€å¤§å›æ’¤äº‹ä»¶åˆ†æ (Top Drawdowns Analysis)

## 1. ç›®æ ‡
ä¸ä»…ä»…è®¡ç®—ä¸€ä¸ªâ€œæœ€å¤§å›æ’¤â€çš„æ•°å€¼ï¼Œè€Œæ˜¯è¦è¯†åˆ«å‡ºå†å²ä¸Š**æ‰€æœ‰çš„**æ˜¾è‘—å›æ’¤äº‹ä»¶ï¼ˆDrawdown Eventsï¼‰ï¼Œå¹¶æŒ‰è·Œå¹…æ’åã€‚

æˆ‘ä»¬éœ€è¦å‘Šè¯‰ç”¨æˆ·ï¼š
> *"QQQ å†å²ä¸Šç¬¬ 1 æƒ¨çš„å›æ’¤å‘ç”Ÿåœ¨ 2000 å¹´äº’è”ç½‘æ³¡æ²«ï¼Œè·Œäº† 80%ï¼Œè€—æ—¶ 15 å¹´å›æœ¬ã€‚"*
> *"ç¬¬ 2 æƒ¨å‘ç”Ÿåœ¨ 2008 å¹´æ¬¡è´·å±æœºï¼Œè·Œäº† 50%ï¼Œè€—æ—¶ 2 å¹´å›æœ¬ã€‚"*

## 2. æ ¸å¿ƒå®šä¹‰ï¼šå›æ’¤äº‹ä»¶ (Drawdown Event)

ä¸€ä¸ªå®Œæ•´çš„â€œå›æ’¤äº‹ä»¶â€åŒ…å«ä¸‰ä¸ªå…³é”®èŠ‚ç‚¹ï¼š

1.  **å³°å€¼ (Peak)**: åˆ›æ–°é«˜çš„é‚£ä¸€å¤©ï¼ˆå›æ’¤å¼€å§‹ï¼‰ã€‚
2.  **è°·åº• (Valley)**: åœ¨æ¢å¤åˆ›æ–°é«˜ä¹‹å‰ï¼Œè·Œå¾—æœ€æ·±çš„é‚£ä¸€å¤©ã€‚
3.  **æ¢å¤ (Recovery)**: ä»·æ ¼é‡æ–°çªç ´ä¹‹å‰å³°å€¼çš„é‚£ä¸€å¤©ï¼ˆå›æ’¤ç»“æŸï¼‰ã€‚
    *   *ç‰¹æ®Šæƒ…å†µ*ï¼šå¦‚æœç›´åˆ°å›æµ‹ç»“æŸè¿˜æ²¡å›åˆ°å³°å€¼ï¼Œåˆ™æ ‡è®°ä¸ºâ€œæœªæ¢å¤ (Unrecovered)â€ã€‚

## 3. æ•°æ®ç»“æ„ (TypeScript)

è¯·åœ¨ `packages/shared/src/api-dtos.ts` æˆ– `types.ts` ä¸­æ·»åŠ ï¼š

```typescript
export interface DrawdownEvent {
  rank: number;             // æ’å (1 = æœ€æƒ¨)
  depthPercent: number;     // è·Œå¹…ç™¾åˆ†æ¯” (ä¾‹å¦‚ -35.42)

  peakDate: string;         // å³°å€¼æ—¥æœŸ
  peakPrice: number;        // å³°å€¼ä»·æ ¼

  valleyDate: string;       // è°·åº•æ—¥æœŸ
  valleyPrice: number;      // è°·åº•ä»·æ ¼

  recoveryDate: string | null; // æ¢å¤æ—¥æœŸ (null è¡¨ç¤ºå°šæœªæ¢å¤)
  daysToRecover: number;    // ä»å³°å€¼åˆ°æ¢å¤è€—æ—¶å¤šå°‘å¤© (æ—¥å†æ—¥)

  isRecovered: boolean;     // çŠ¶æ€æ ‡è®°
}

// æ›´æ–° BacktestResultDTO
export interface BacktestResultDTO {
  // ... åŸæœ‰å­—æ®µ
  analysis: {
    topDrawdowns: DrawdownEvent[]; // å†å²å‰ 10 å¤§å›æ’¤
  };
}
```

## 4. ç®—æ³•é€»è¾‘ (The Underwater Algorithm)

æˆ‘ä»¬éœ€è¦ä¸€æ¬¡éå† (`O(N)`) å®Œæˆæ‰€æœ‰è®¡ç®—ã€‚

### å˜é‡å‡†å¤‡
*   `runningMax`: å½“å‰é‡åˆ°çš„å†å²æœ€é«˜ä»·ï¼Œåˆå§‹åŒ–ä¸º `-Infinity`ã€‚
*   `peakDate`: å½“å‰ `runningMax` å‡ºç°çš„æ—¥æœŸã€‚
*   `currentDrawdown`: å½“å‰æ­£åœ¨è¿›è¡Œçš„å›æ’¤äº‹ä»¶å¯¹è±¡ï¼ˆå¦‚æœæ­£åœ¨å›æ’¤ä¸­ï¼‰ã€‚
*   `completedDrawdowns`: åˆ—è¡¨ï¼Œå­˜å‚¨å·²ç»æ¢å¤çš„å›æ’¤äº‹ä»¶ã€‚

### éå†æ­¥éª¤

1.  éå†æ¯ä¸€å¤©çš„ ETF ä»·æ ¼æ•°æ®ã€‚
2.  **åˆ¤æ–­åˆ›æ–°é«˜**ï¼š
    *   å¦‚æœ `Close > runningMax`:
        *   **ç»“ç®—æ—§å›æ’¤**ï¼šå¦‚æœä¹‹å‰å¤„äºå›æ’¤çŠ¶æ€ (`currentDrawdown` å­˜åœ¨)ï¼Œè¯´æ˜ä»Šå¤©å½»åº•å¡«å‘äº†ã€‚è®°å½• `recoveryDate = Today`ï¼Œè®¡ç®— `daysToRecover`ï¼Œå¹¶å°†è¯¥äº‹ä»¶å­˜å…¥åˆ—è¡¨ã€‚
        *   **æ›´æ–°å³°å€¼**ï¼š`runningMax = Close`, `peakDate = Today`ã€‚
        *   **é‡ç½®çŠ¶æ€**ï¼šæ¸…ç©º `currentDrawdown`ã€‚
3.  **åˆ¤æ–­å›æ’¤**ï¼š
    *   å¦‚æœ `Close < runningMax`:
        *   **è®¡ç®—å½“å‰æ·±åº¦**ï¼š`depth = (Close - runningMax) / runningMax`ã€‚
        *   **çŠ¶æ€ç»´æŠ¤**ï¼š
            *   å¦‚æœæ˜¯åˆšå¼€å§‹è·Œï¼šåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ `currentDrawdown` äº‹ä»¶ã€‚
            *   å¦‚æœæ˜¯æ­£åœ¨è·Œï¼šæ£€æŸ¥ `depth` æ˜¯å¦æ¯”è®°å½•çš„ `valleyDepth` æ›´æ·±ã€‚å¦‚æœæ˜¯ï¼Œæ›´æ–° `valleyDate` å’Œ `valleyPrice`ã€‚
4.  **æ”¶å°¾å¤„ç†**ï¼š
    *   éå†ç»“æŸåï¼Œå¦‚æœè¿˜æœ‰ä¸€ä¸ª `currentDrawdown` æ²¡ç»“æŸï¼ˆè¯´æ˜å½“å‰æ­£å¤„äºäºæŸä¸­ï¼Œæˆ–è€…å›æµ‹ç»“æŸæ—¶è¿˜æ²¡æ¶¨å›å»ï¼‰ï¼Œå°†å…¶æ ‡è®°ä¸º `isRecovered = false`ï¼Œå­˜å…¥åˆ—è¡¨ã€‚
5.  **æ’åºä¸è¿‡æ»¤**ï¼š
    *   æŒ‰ `depthPercent` å‡åºæ’åºï¼ˆå› ä¸ºæ˜¯è´Ÿæ•°ï¼Œè¶Šå°è¶Šæƒ¨ï¼‰ã€‚
    *   å–å‰ 5 æˆ– å‰ 10 åã€‚

## 5. ä»£ç å®ç° (BacktestEngine)

è¯·å°†æ­¤æ–¹æ³•æ·»åŠ åˆ° `BacktestEngine` ç±»ä¸­ï¼Œå¹¶åœ¨ `runBacktest` ç»“æŸå‰è°ƒç”¨ã€‚

```typescript
  /**
   * è®¡ç®—å†å²å‰ N å¤§å›æ’¤äº‹ä»¶
   * @param data ETF ä»·æ ¼æ•°æ®
   * @param topN è¿”å›å‰å‡ å (é»˜è®¤ 5)
   */
  private calculateTopDrawdowns(data: ETFDataPoint[], topN: number = 5): DrawdownEvent[] {
    const events: DrawdownEvent[] = [];

    let runningMax = -Infinity;
    let peakDate = '';

    // ä¸´æ—¶å­˜å‚¨å½“å‰æ­£åœ¨å‘ç”Ÿçš„å›æ’¤
    let currentEvent: Partial<DrawdownEvent> | null = null;

    for (const point of data) {
      const price = point.c;
      const date = point.d;

      if (price >= runningMax) {
        // --- åœºæ™¯ A: åˆ›æ–°é«˜ (æˆ–è€…æŒå¹³) ---

        // 1. å¦‚æœä¹‹å‰æœ‰æ­£åœ¨è¿›è¡Œçš„å›æ’¤ï¼Œè¯´æ˜ä»Šå¤©â€œå›æœ¬â€äº†
        if (currentEvent) {
          currentEvent.recoveryDate = date;
          currentEvent.isRecovered = true;
          currentEvent.daysToRecover = this.calculateDaysBetween(currentEvent.peakDate!, date);

          // åªæœ‰å›æ’¤å¹…åº¦è¶…è¿‡ä¸€å®šé˜ˆå€¼ (ä¾‹å¦‚ 1%) æ‰è®°å½•ï¼Œè¿‡æ»¤å™ªéŸ³
          if (currentEvent.depthPercent! < -1.0) {
             // å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“è¿™äº›å­—æ®µä¸€å®šå­˜åœ¨
             events.push(currentEvent as DrawdownEvent);
          }
          currentEvent = null;
        }

        // 2. æ›´æ–°æ–°çš„å³°å€¼
        runningMax = price;
        peakDate = date;

      } else {
        // --- åœºæ™¯ B: å¤„äºå›æ’¤ä¸­ (æ°´ä¸‹) ---

        const depth = ((price - runningMax) / runningMax) * 100;

        if (!currentEvent) {
          // åˆšå¼€å§‹è·Œï¼Œåˆå§‹åŒ–äº‹ä»¶
          currentEvent = {
            rank: 0, // ç¨åæ’åºå¡«å……
            depthPercent: depth,
            peakDate: peakDate,
            peakPrice: runningMax,
            valleyDate: date,
            valleyPrice: price,
            recoveryDate: null,
            isRecovered: false,
            daysToRecover: 0 // æš‚æ—¶æœªå®š
          };
        } else {
          // å·²ç»åœ¨è·Œäº†ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯è·Œå¾—æ›´æ·±äº†
          if (depth < currentEvent.depthPercent!) {
            currentEvent.depthPercent = depth;
            currentEvent.valleyDate = date;
            currentEvent.valleyPrice = price;
          }
        }
      }
    }

    // --- æ”¶å°¾: å¤„ç†ç›´åˆ°å›æµ‹ç»“æŸè¿˜æ²¡å›æœ¬çš„æœ€åä¸€æ¬¡å›æ’¤ ---
    if (currentEvent) {
       // è®¡ç®—æˆªæ­¢åˆ°å›æµ‹ç»“æŸæ—¥æœŸçš„å¤©æ•°
       const lastDate = data[data.length - 1].d;
       currentEvent.daysToRecover = this.calculateDaysBetween(currentEvent.peakDate!, lastDate);

       if (currentEvent.depthPercent! < -1.0) {
         events.push(currentEvent as DrawdownEvent);
       }
    }

    // --- æ’åºä¸æ’å ---
    // æŒ‰è·Œå¹…ä»å°åˆ°å¤§æ’åº (ä¾‹å¦‚ -50% æ’åœ¨ -10% å‰é¢)
    const sortedEvents = events.sort((a, b) => a.depthPercent - b.depthPercent);

    // å–å‰ N åå¹¶æ ‡è®° Rank
    return sortedEvents.slice(0, topN).map((e, index) => ({
      ...e,
      rank: index + 1
    }));
  }
```

## 6. å‰ç«¯å±•ç¤ºå»ºè®®

è¿™æ˜¯ä¸€ä¸ªéå¸¸æ£’çš„æ•…äº‹è®²è¿°æ¨¡å—ã€‚å»ºè®®åœ¨ç»“æœé¡µæ·»åŠ ä¸€ä¸ª **â€œå‹åŠ›æµ‹è¯• (Stress Test)â€** æˆ– **â€œå†å²å›æ’¤â€** å¡ç‰‡ã€‚

**å±•ç¤ºå½¢å¼ï¼šè¡¨æ ¼**

| æ’å | å›æ’¤æ—¶æœŸ (å³°å€¼ -> è°·åº•) | è·Œå¹… | æ¢å¤è€—æ—¶ | çŠ¶æ€ |
| :--- | :--- | :--- | :--- | :--- |
| ğŸ¥‡ | **2020/02/19** -> 2020/03/23 | <span style="color:red">-34.1%</span> | 148 å¤© | âœ… å·²æ¢å¤ |
| ğŸ¥ˆ | **2022/01/03** -> 2022/10/14 | <span style="color:red">-32.5%</span> | -- | âŒ æœªæ¢å¤ |

**ç”¨æˆ·ä»·å€¼**ï¼š
å½“ç”¨æˆ·çœ‹åˆ° QQQ å†å²ä¸Šåªè¦ 148 å¤©å°±èƒ½ä» -34% çš„å¤§å‘é‡Œçˆ¬å‡ºæ¥æ—¶ï¼Œä»–ä»¬å¯¹å®šæŠ•ç­–ç•¥çš„ä¿¡å¿ƒä¼šå€å¢ã€‚è¿™å°±æ˜¯æ•°æ®çš„åŠ›é‡ã€‚
