# 回测引擎核心算法与设计

**版本**: 1.0
**最后更新**: 2025 年 11 月 21 日
**状态**: 核心逻辑重构中

本文档详细论述了 ETF 投资策略设计器的回测引擎核心算法。它涵盖了从数据处理、信号生成到交易执行的完整生命周期，并重点分析了当前实现的局限性及即将实施的修正方案（特别是针对前视偏差的修正）。

## 1. 算法概述

回测引擎的目标是模拟策略在历史市场数据上的表现。我们的设计哲学是**“基于事件的日线级回测”**。

- **输入**: 用户定义的策略配置 (`StrategyConfig`) 和清洗后的 ETF 历史数据 (`ETFData`)。
- **处理**: 按时间顺序遍历每一天，根据当日及历史数据判断是否触发交易信号。
- **输出**: 包含资金曲线、交易记录和绩效指标的详细报告 (`BacktestResultDTO`)。

## 2. 核心逻辑流程

回测的核心是一个按日期推进的时间步进循环 (Time-Stepping Loop)。

### 2.1 数据预处理

1.  **排序**: 确保 ETF 数据严格按日期升序排列。
2.  **过滤**: 根据策略设定的 `startDate` 和 `endDate` 截取数据片段。
3.  **初始化**: 建立初始账户状态（现金 = 初始资本，持仓 = 0）。

### 2.2 逐日回测循环 (The Loop)

对于回测区间内的每一天 $T$：

1.  **更新账户价值**:

    - 根据 $T$ 日收盘价 ($Close_T$) 更新持仓市值。
    - $TotalValue_T = Cash + (Positions \times Close_T)$。
    - 记录当日账户快照。

2.  **执行待处理订单 (Order Execution)**:

    - _当前逻辑 (待修正)_: 在信号触发当日立即成交。
    - **目标逻辑 (修正后)**: 检查是否有 $T-1$ 日产生的交易信号。如果有，以 $T$ 日的 **开盘价 ($Open_T$)** 执行交易。这是消除“前视偏差”的关键。

3.  **信号检测 (Signal Generation)**:

    - 基于 $T$ 日收盘数据 ($Close_T, High_T, Low_T$) 及历史窗口数据，计算技术指标（如 MA, RSI, 回撤幅度）。
    - 遍历策略中的所有触发器 (`Triggers`)。
    - 若满足条件且不在冷却期内，生成交易信号。

4.  **状态流转**:
    - 更新触发器的“最后执行时间”。
    - 将信号转换为待处理订单，传入 $T+1$ 日。

## 3. 详细机制

### 3.1 触发器系统 (Trigger System)

引擎支持模块化的触发条件，通过 `checkTriggerCondition` 分发：

- **Drawdown**: 从近期高点的回撤幅度。
- **Price Streak**: 连续 N 天涨/跌。
- **New High/Low**: 创 N 日新高/新低。
- **MA Cross**: 均线交叉（金叉/死叉）。
- **RSI**: 超买/超卖检测。

### 3.2 交易执行与资金管理

交易动作定义了“买什么”和“卖多少”。

- **买入 (Buy)**:
  - `fixedAmount`: 固定金额买入。
  - `cashPercent`: 使用当前现金的 X% 买入。
  - `totalValuePercent`: 目标仓位管理（例如：加仓至总资产的 50%）。
- **卖出 (Sell)**:
  - `fixedAmount`: 卖出指定价值的份额（需修正计算逻辑）。
  - `positionPercent`: 卖出当前持仓的 X%。
  - `totalValuePercent`: 减仓至总资产的 X%。

## 4. 缺陷分析与修正方案 (Critical Fixes)

为了确保回测结果的真实性，必须对当前算法进行以下核心修正。

### 4.1 消除“穿越未来”偏差 (Look-ahead Bias)

- **现状**: 在第 $T$ 日收盘后计算出信号，并立即以第 $T$ 日收盘价成交。
- **问题**: 现实中，当你确认收盘价指标时，市场已关闭，无法交易。这会导致回测收益虚高。
- **修正方案**:
  - **信号生成**: 保持在 $T$ 日收盘后进行。
  - **交易执行**: 强制推迟到 $T+1$ 日。
  - **成交价格**: 使用 $T+1$ 日的 **Open Price**。

### 4.2 卖出逻辑 Bug 修复

- **现状**: `calculateSellQuantity` 中 `fixedAmount` 模式错误地计算为 `amount / positions`。
- **修正**: 应计算为 `amount / currentPrice`，即“想卖出的金额除以当前单价”得到股数。

## 5. 未来演进 (Roadmap)

### 5.1 交易摩擦 (Friction)

- 引入佣金 (`commission`) 和滑点 (`slippage`) 模型，使高频策略的成本更真实。

### 5.2 现金流管理

- **股息 (Dividends)**: 支持股息再投资或现金派发。
- **闲置资金利息**: 为空仓部分的现金计算无风险收益 (Risk-Free Rate)。

### 5.3 高级风控

- **止损/止盈 (Stop Loss / Take Profit)**: 独立于入场信号的退出逻辑，支持移动止损 (Trailing Stop)。
