

### **技术栈文档：ETF 投资策略设计与回测工具**



#### **1. 概述与架构哲学**

本项目旨在构建一个基于 Web 的 ETF 投资策略回测工具。为了实现全球用户的高性能访问、极致的可伸缩性以及最小化的运维成本，我们选择了一个完全基于 **Cloudflare 开发平台**的 **Serverless 和边缘优先 (Edge-First)** 架构。用户身份认证则通过集成的 **Firebase Authentication** 服务来处理，以确保安全性和易用性。

**核心架构原则**:
*   **边缘计算**: 将前端和后端逻辑尽可能地部署在 Cloudflare 的全球边缘网络上，最大化地贴近用户，减少延迟。
*   **按需付费**: 所有核心服务均采用按使用量付费的模式，没有闲置的服务器成本。
*   **前后端分离**: 清晰的前后端职责分离，通过 API 进行通信。
*   **基础设施即代码 (IaC)**: 通过 Cloudflare 的 `wrangler` CLI 工具管理和部署后端服务。

---

#### **2. 核心技术栈详解**

| **功能模块** | **选用技术** | **角色与职责** | **选用理由** |
| :--- | :--- | :--- | :--- |
| **前端框架与 UI** | **Vue 3 (Composition API), Tailwind CSS v4, shadcn-vue, Vite** | 构建响应式、可交互的用户界面；提供一致、美观且可访问的 UI 组件；定义应用的视觉风格和布局；提供极速的开发构建体验。 | **Vue 3** 提供了成熟的响应式系统和卓越的开发体验。**Tailwind CSS** 极大提升了 UI 开发效率并保证了设计一致性。**shadcn-vue** 提供了美观、可访问且完全可定制的组件基础，避免了传统 UI 库的僵化。**Vite** 提供了无与伦比的开发服务器速度和构建性能。 |
| **前端部署** | **Cloudflare Pages** | 托管和全球分发静态前端资源（HTML, CSS, JS）。 | 与 GitHub/GitLab 深度集成，提供 CI/CD 自动化。每次 `git push` 即可触发自动构建和部署，实现原子化、即时回滚的部署。 |
| **后端逻辑** | **Cloudflare Workers** | 运行无服务器的后端 API。负责处理业务逻辑，如：接收回测请求、调用数据源、执行策略计算、与数据库交互。 | 在 Cloudflare 全球边缘节点运行，延迟极低。基于 Service Worker API，启动速度极快（无冷启动问题）。使用 TypeScript/JavaScript 编写。 |
| **数据存储 (用户数据)** | **Cloudflare D1** | 存储用户的核心业务数据，如：用户保存的策略、回测历史记录、用户偏好设置等。 | 一个基于 SQLite 构建的 Serverless SQL 数据库。提供了关系型数据库的能力，同时保持了 Serverless 的易用性和可扩展性。 |
| **数据存储 (缓存)** | **Cloudflare KV** | 作为高性能缓存层，存储从外部数据源（雅虎财经）获取的 ETF 历史数据。 | 一个全球分布的键值(Key-Value)存储。读操作极快（个位数毫秒），非常适合缓存不经常变动但需要频繁读取的数据。 |
| **用户认证** | **Firebase Authentication** | 处理用户的注册、登录（支持邮箱/密码、Google、GitHub 等多种方式）、密码重置和会话管理。 | 提供了一整套安全、可靠、易于集成的身份认证解决方案。SDK 支持完善，免去了自建认证系统的复杂性和安全风险。 |
| **外部数据源** | **Yahoo Finance API** | 提供 ETF 历史行情数据。 | 数据全面、历史悠久且免费，社区有成熟的 TS/JS 库 (`yahoo-finance2`) 支持，是回测数据的理想来源。 |

---

#### **3. 前端技术栈详解**

为了构建一个现代化、可维护且高效的前端应用，我们精心选择了以下技术组合：

*   **核心框架：Vue 3 (Composition API)**
    *   **角色**: 作为应用的基石，负责管理组件状态、响应式数据流和渲染逻辑。
    *   **理由**: 我们将全面拥抱 **组合式 API (Composition API)**，它使得复杂组件的逻辑组织变得极为清晰和可复用。通过 `ref`、`reactive`、`computed` 等核心 API，我们可以构建出高度可维护的状态管理逻辑。同时，其一流的 TypeScript 支持为项目的长期稳定性提供了保障。

*   **构建工具：Vite**
    *   **角色**: 提供开发服务器和生产环境构建能力。
    *   **理由**: Vite 利用浏览器原生的 ES 模块，提供了**闪电般的冷启动速度**和**近乎即时的热模块更新 (HMR)**，这极大地提升了开发过程中的幸福感和效率。其基于 Rollup 的构建打包也为生产环境提供了高度优化的输出。

*   **CSS 框架：Tailwind CSS v4**
    *   **角色**: 负责应用中所有的样式和视觉设计。
    *   **理由**: 我们采用 **Utility-First (功能优先)** 的理念，直接在 HTML 中通过组合原子化的 CSS 类来构建 UI，无需编写一行自定义 CSS。这保证了整个应用视觉风格的高度一致性，并加快了开发速度。我们将采用即将推出的 **V4 版本**，以利用其全新的高性能引擎和简化的配置。

*   **UI 组件库：shadcn-vue**
    *   **角色**: 提供高质量、可访问的 UI 组件基础，如按钮、输入框、**对话框 (Dialog)**、下拉菜单等。
    *   **理由**: shadcn-vue 并非传统的 UI 库，它是一种创新的组件构建方式。我们不把它作为 npm 依赖安装，而是通过 CLI **将组件的源代码直接复制到我们的项目中**。
        *   **完全所有权**: 我们拥有组件的每一行代码，可以随心所欲地修改其样式和行为，无需担心库的更新破坏或与自定义样式冲突。
        *   **设计精美**: 组件的设计风格现代、简洁，并且完全基于 Tailwind CSS 构建，实现了完美的集成。
        *   **可访问性 (Accessibility)**: 底层基于 Radix Vue，确保了所有组件都符合 WAI-ARIA 标准，对所有用户都友好。
        *   **按需使用**: 只添加我们需要的组件，保持项目代码的轻量和整洁。

这个前端技术栈的组合，让我们既能享受到 Vue 3 强大的开发范式，又能利用 Tailwind CSS 和 shadcn-vue 快速构建出既美观又完全可控的定制化用户界面。

#### 4. 数据与认证流程
用户请求: 用户在浏览器中（Cloudflare Pages）设计好策略，点击“运行回测”。
API 调用: 前端应用向后端 API（Cloudflare Workers）发起一个 POST 请求，请求体中包含策略的定义。
缓存检查:
Cloudflare Worker 首先根据 ETF 代码和时间范围，在 Cloudflare KV 中查找是否存在缓存的历史数据。
缓存命中: 如果命中，直接从 KV 中读取数据，进入下一步。
缓存未命中: 如果未命中，Worker 调用 yahoo-finance2 库，从 Yahoo Finance 获取数据。获取成功后，将数据存入 Cloudflare KV 以备后续使用，然后进入下一步。
回测计算: Worker 在内存中执行回测算法，模拟交易过程。
结果存储 (可选): 如果需要保存用户的回测历史，Worker 会将回测结果和策略定义存入 Cloudflare D1 数据库。
响应返回: Worker 将计算出的回测报告（KPIs、净值曲线数据等）以 JSON 格式返回给前端。
前端渲染: 前端应用接收到数据后，通过图表和卡片将结果可视化地呈现给用户。
注册/登录: 用户在前端应用中，通过 Firebase SDK 提供的 UI 组件或方法进行注册或登录。
获取 Token: 成功登录后，Firebase Auth 会返回一个 JWT (JSON Web Token) 给前端应用。
API 请求授权: 前端在之后所有需要授权的 API 请求（如保存策略、查看历史记录）的 Authorization 请求头中，附带上这个 JWT (Bearer <JWT>)。
后端验证:
Cloudflare Worker 接收到请求后，提取出 JWT。
Worker 使用 Firebase 提供的公钥来验证该 JWT 的签名和有效期，确保它是由 Firebase 签发且未被篡改。
验证通过后，Worker 从 JWT 的载荷(payload)中解析出用户的唯一 ID (uid)，并执行相应的业务逻辑（例如，将策略存入该 uid 名下）。
验证失败则返回 401 Unauthorized 错误。

#### 5. 开发与部署 (DevOps)
代码仓库: GitHub / GitLab。
前端部署: 将代码仓库与 Cloudflare Pages 项目关联，主分支的每次推送都会自动触发部署。
后端部署: 使用 Wrangler CLI。在本地开发、测试，并通过 wrangler deploy 命令将 Worker 和 D1 数据库的变更部署到 Cloudflare 网络。此过程可通过 GitHub Actions 实现自动化。